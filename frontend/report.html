<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="data:image/png;base64,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">
  <title>
    Report Preview
  </title>
  <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        img {
            max-width: 100px;
            max-height: 100px;
            cursor: pointer; /* Add cursor pointer for clickable images */
        }

        /* Modal styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
    }

    .modal-content {
        margin: 5% auto; /* 5% from the top and centered */
        display: block;
        max-width: 90%; /* Max width of modal */
        max-height: 90%; /* Max height of modal */
    }

    .modal-content img {
        width: 100%;
        height: auto;
    }

    /* Close button */
    .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #fff;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #ccc;
        text-decoration: none;
        cursor: pointer;
    }
    </style>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.1.0" rel="stylesheet" />
  <!-- Nepcha Analytics (nepcha.com) -->
  <!-- Nepcha is a easy-to-use web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. -->
  <script defer data-site="YOUR_DOMAIN_HERE" src="https://api.nepcha.com/js/nepcha-analytics.js"></script>
</head>

<body class="g-sidenav-show  bg-gray-200">
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true"">
          
              <img src="https://www.tranetechnologies.com/content/dam/cs-corporate/images/logos/logo-TT.svg" alt="" width="70" height="50" alt="">
            <button class="navbar-toggler shadow-none ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon mt-2">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </span>
            </button>
            <div class="collapse navbar-collapse" id="navigation">
              <ul class="navbar-nav mx-auto">
			  <li class="nav-item">
                  <a class="nav-link me-2" href="index.html">
                    <i class="fas fa-key opacity-6 text-dark me-1"></i>
                    Project Details
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link d-flex align-items-center me-2 active" aria-current="page" href="protocols.html">
                    <i class="fa fa-chart-pie opacity-6 text-dark me-1"></i>
                    Project Checklist
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link me-2" href="report.html">
                    <i class="fa fa-user opacity-6 text-dark me-1"></i>
                    Report
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
        </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card my-4">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
              <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                <h6 class="text-white text-capitalize ps-3">Report Preview</h6>
              </div>
            </div>
			<form id="reportForm">
			<div class="col-12">
				<br><label for="projectName">Project Name:</label>
				<select id="projectName" class="selectpicker">
					<!-- Projects will be populated dynamically -->
				</select>
				<!--<input class="col-2" type="text" id="projectName" name="projectName" required>-->
				<button type="submit">Generate Preview</button>
				    
				<button id="generateReportBtn">Generate Report</button>
				<button id="downloadReportBtn" style="display:none">Download Report</button>
			</div>
			<div class="container mt-5">
				<div id="alert_success" class="alert alert-success" role="alert" style="display: none; color:white">
					Report downloaded successfully
				</div>
			</div>
			<div class="container mt-5">
				<div id="alert_success1" class="alert alert-success" role="alert" style="display: none; color:white">
					Report generated successfully
				</div>
			</div>
			<div class="container mt-5">
				<div id="alert_error" class="alert alert-danger" role="alert" style="display: none; color:white">
					Please upload in the the Pentest Checklist
				</div>
			</div>	
			</form>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive p-0">
                <!----blah--->
				<!-- Display project owner here -->
				<h5 id="projectOwnerLabel"></h5><br>

				<div id="reportData"></div>

				<!-- The Modal -->
				<div id="imageModal" class="modal">
					<span class="close">&times;</span>
					<img class="modal-content" id="expandedImg">
				</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div class="fixed-plugin">
    
    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3">
        <div class="float-start">
          <h5 class="mt-3 mb-0">Material UI Configurator</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="material-icons">clear</i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-gradient-primary active" data-color="primary" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between 2 different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn bg-gradient-dark px-3 mb-2 active" data-class="bg-gradient-dark" onclick="sidebarType(this)">Dark</button>
          <button class="btn bg-gradient-dark px-3 mb-2 ms-2" data-class="bg-transparent" onclick="sidebarType(this)">Transparent</button>
          <button class="btn bg-gradient-dark px-3 mb-2 ms-2" data-class="bg-white" onclick="sidebarType(this)">White</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="mt-3 d-flex">
          <h6 class="mb-0">Navbar Fixed</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
          </div>
        </div>
        <hr class="horizontal dark my-3">
        <div class="mt-2 d-flex">
          <h6 class="mb-0">Light / Dark</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version" onclick="darkMode(this)">
          </div>
        </div>
        <hr class="horizontal dark my-sm-4">
        <a class="btn bg-gradient-info w-100" href="https://www.creative-tim.com/product/material-dashboard-pro">Free Download</a>
        <a class="btn btn-outline-dark w-100" href="https://www.creative-tim.com/learning-lab/bootstrap/overview/material-dashboard">View documentation</a>
        <div class="w-100 text-center">
          <a class="github-button" href="https://github.com/creativetimofficial/material-dashboard" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star creativetimofficial/material-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="https://twitter.com/intent/tweet?text=Check%20Material%20UI%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fsoft-ui-dashboard" class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/material-dashboard" class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>
  <script>
  // Fetch projects and populate the project dropdown
fetch('/get-projects')
    .then(response => response.json())
    .then(data => {
        const projectsDropdown = document.getElementById('projectName');
        
        // Add default option
        const defaultProjectOption = document.createElement('option');
        defaultProjectOption.value = '';
        defaultProjectOption.text = 'Select Project';
        projectsDropdown.appendChild(defaultProjectOption);
        
        // Add projects from database
        data.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.text = project;
            projectsDropdown.appendChild(option);
        });
    })
    .catch(error => console.error('Error fetching projects:', error));
  </script>
  
  <!--custom JS-->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!--<script src="script.js"></script>-->
  <!--   Core JS Files   -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <script>
        document.getElementById('reportForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const projectName = document.getElementById('projectName').value;

            try {
                const response = await fetch('/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ projectName })
                });

                if (!response.ok) {
                    const errorMessage = await response.text();
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                displayReport(data);
            } catch (error) {
                console.error('Error generating report:', error);
                //alert('Failed to generate report. Please try again.');
				showAlert_error();
            }
        });

        function displayReport(data) {
            const reportContainer = document.getElementById('reportData');
            reportContainer.innerHTML = '';

            const table = document.createElement('table');
            const headerRow = table.insertRow();
            headerRow.innerHTML = '<th>Protocol</th><th>Detection Name</th><th>Images</th>';

            const groupedData = groupByProtocolAndDetectionName(data);

            groupedData.forEach(group => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${group.protocol}</td>
                    <td>${group.detection_name}</td>
                    <td>${group.images.map(image => `<img class="modalImg" src="data:image/jpeg;base64,${image}" alt="Image" />`).join('')}</td>
                `;
            });

            reportContainer.appendChild(table);

            // Add click event listener to images to open modal
            const images = document.querySelectorAll('.modalImg');
            images.forEach(img => {
                img.addEventListener('click', function() {
                    const modal = document.getElementById('imageModal');
                    const modalImg = document.getElementById('expandedImg');
                    modal.style.display = 'block';
                    modalImg.src = this.src;

                    // Close modal when clicked outside the image
                    modal.onclick = function() {
                        modal.style.display = 'none';
                    };
                });
            });

            // Display project owner
            const projectOwnerLabel = document.getElementById('projectOwnerLabel');
            projectOwnerLabel.textContent = `Project Owner: ${data[0].project_owner}`;
        }

        function groupByProtocolAndDetectionName(data) {
            const groupedData = {};
            data.forEach(finding => {
                const key = `${finding.protocol}-${finding.detection_name}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        protocol: finding.protocol,
                        detection_name: finding.detection_name,
                        images: []
                    };
                }
                groupedData[key].images.push(finding.imageData);
            });
            return Object.values(groupedData);
        }

//generate report

const generateReportBtn = document.getElementById('generateReportBtn');
const downloadReportBtn = document.getElementById('downloadReportBtn');
const projectNameInput = document.getElementById('projectName');

generateReportBtn.addEventListener('click', () => {
    const projectName = projectNameInput.value;
    console.log('Project Name:', projectName); // Log the project name
            //alert('Report generated successfully');
			showAlert_success1();			// Alert after report generation
            downloadReportBtn.style.display = 'inline'; // Show download button after report generation
    axios.get(`/generate-report?projectName=${projectName}`)
        .then(response => {
            console.log(response.data);
            //alert('Report downloaded successfully'); // Alert after report generation
			
            downloadReportBtn.style.display = 'inline'; // Show download button after report generation
        })
        .catch(error => {
            console.error(error);
            alert('Error generating report');
        });
});

	
function showAlert_success1() {
        document.getElementById('alert_success1').style.display = 'block';
        // Hide the alert after 2 seconds
        setTimeout(function() {
            document.getElementById('alert_success1').style.display = 'none';
        }, 2000);
    }
	
function showAlert_error() {
			document.getElementById('alert_error').style.display = 'block';
			// Hide the alert after 2 seconds
			setTimeout(function() {
				document.getElementById('alert_error').style.display = 'none';
			}, 2000);
		}


downloadReportBtn.addEventListener('click', () => {
    const projectName = projectNameInput.value;
    console.log('Project Name:', projectName); // Log the project name

    // Send a GET request to download the report
    axios.get(`/download-report?projectName=${projectName}`, { responseType: 'blob' }) // Set responseType to 'blob'
        .then(response => {
            const blob = new Blob([response.data], { type: 'application/octet-stream' });
            const url = window.URL.createObjectURL(blob);

            // Create a temporary link element to initiate the download
            const link = document.createElement('a');
            link.href = url;
            link.download = `report_${projectName}.docx`; // Set the filename for download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        })
        .catch(error => {
            console.error(error);
            alert('Error downloading report');
        });
});




    </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/material-dashboard.min.js?v=3.1.0"></script>
</body>

</html>